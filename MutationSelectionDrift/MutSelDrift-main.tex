\section{Introduction}
\label{sec:Introduction}

Since the realization, by \citet{Zuckerkandl1965} that genetic sequences are informative about the evolutionary history of the species, molecular phylogenetics has developed into a mature and very active field.
A broad array of models and inference methods have been developed, using DNA sequences for reconstructing the phylogenetic relationships among species~\citep{Felsenstein1981}, for estimating divergence times~\citep{Thorne2002}, or for reconstructing the genetic sequences of remote ancestors~\citep{Liberles2007}.
However, genetic sequences might contain information about other aspects of the evolutionary history and, in particular, about past population-genetic regimes.

Interspecific divergence is the long-term outcome of population-genetic processes, in which point mutations at the level of individuals are then subjected to selection and genetic drift, leading to substitutions at the level of the population.
As a result, the substitution patterns that can be reconstructed along phylogenies are modulated by the underlying population-genetic parameters (mutation biases, selective landscapes, effective population size), suggesting the possibility to infer the past variation of these parameters over the phylogeny.
Independently, ecological properties such as phenotypic characters or life-history traits can be observed in extinct or in present-day species.
Using the comparative method~\citep{Felsenstein1985}, these traits can be reconstructed for the unobserved ancestral species.
Combined together, genetic and phenotypic ancestral reconstructions can then be used to unravel the interplay between evolutionary and ecological mechanisms.

Practically, in order to disentangle mutation, selection and genetic drift, we need to classify individual substitutions into different categories, differing in the strength of mutation, selection or genetic drift.
In protein-coding \acrshort{DNA} sequences, the mutational process occurs at the nucleotide level.
Assuming that synonymous mutations are selectively neutral and that selection mostly acts at the protein level, synonymous substitutions can be used to infer the pattern of mutationS, without any interference contributed by selection.
Then, by comparing the non-synonymous substitution rate relative to the synonymous substitution rate (the ratio $\dnds$), one can estimate the global strength of selection acting on proteins.
This idea was formalized using phylogenetic codon models~\citep{Muse1994,Goldman1994}.
This led to a broad range of applications, either to detect proteins under adaptive selection~\citep{Kosiol2008}, or to measure the modulations of the strength of purifying selection between sites~\citep{Echave2016}, genes~\citep{Zhang2015}, or lineages~\citep{Lartillot2011}.

Concerning variation in $\dnds$ between lineages, and in a context mostly characterized by purifying selection, the nearly-neutral theory predicts that changes in the global strength of selection (measured as $\dnds$) is related to changes in the relative strength of genetic drift, which is in turn mediated by changes in effective population size ($\Ne$)~\citep{Ohta1992}.
Mechanistically, population with high $\Ne$ are characterized by more efficient purifying selection against mildly deleterious mutations, resulting in lower $\dnds$~\citep{Kimura1979, Welch2008}.

Codon models have been used to empirically measure such changes in the efficacy of purifying selection along phylogenies, either by allowing for different $\dnds$ values in different parts of the tree~\citep{Dutheil2012}, or by estimating a $\dnds$ independently for every branch of the tree~\citep{Popadin2007}.
Alternatively, the $\dnds$ can be modelled as a continuous trait, varying along the phylogeny as a stochastic process, splitting at each node of the tree into independent processes~\citep{Seo2004}.
Once empirical estimates of the variation in $\dnds$ between lineages or groups has been obtained, these can be compared to changes in $\Ne$ across lineages, so as to test the validity of the predictions of the nearly-neutral theory.
Independent empirical estimation of $\Ne$ is usually done vie proxies, such as neutral diversity within species~\citep{Galtier2016}, or such as life-history traits.
For instance, animal species characterized by a large body size or an extended longevity are typically expected to also have a low $\Ne$~\citep{Romiguier2014}.
Alternatively, a Bayesian integrative framework has been proposed~\citep{Lartillot2011}, in which the joint variation in $\dnds$ and in life-history traits or other proxies of $\Ne$ is modelled as a multivariate Brownian process, with a variance-covariance matrix capturing the signal about their correlated evolution.

Analyses using these approaches and these proxies of $\Ne$ have suggested a negative correlation between $\dnds$ and $\Ne$~\citep{Popadin2007, Lanfear2010, Lartillot2011, Lartillot2012, Romiguier2014, Figuet2017}, thus confirming the theoretical prediction of the nearly-neutral theory.
However, the universality and robustness of these correlations is still debated~\citep{Nabholz2013,Lanfear2014,Figuet2016, Bolivar2019}, and further investigation might be required.
Moreover, these analyses do not explicitly formalize the quantitative relationship between $\Ne$ and $\dnds$.
This relation is in principle dependent on the underlying fitness landscape~\citep{Welch2008}, and can show complicated behaviors due to non-equilibrium properties~\citep{Jones2016}.
These questions could be addressed in the context of a mechanistic modeling approach.

As an alternative to classical $\dnds$-based codon models, mechanistic codon models explicitly introduce population genetic equations into the codon substitution process~\citep{Halpern1998}.
Specifically, these so-called mutation-selection codon models explicitly assign a fitness parameter to each amino-acid.
As a result, the substitution rate between each pair of codons can be predicted, as the product of the mutation rate and the fixation probability of the new codon, which is in turn dependent on the fitness of the initial and the final codons.
Since the strength of selection is typically not homogeneous along the protein sequence, and depends on the local physicochemical requirements~\citep{Echave2016, Goldstein2016,Goldstein2017}, local changes in selective strength is usually taken into account by allowing for site-specific amino-acid fitness profiles.
The sparsity of signal per codon site, however, requires to aggregate sites in categories, such as to gather enough signal for each amino-acid fitness profile.
Conversely, the category assigned to each site is chosen such that the sites aggregated into the same category share patterns of selection and hopefully the same physicochemical properties.
Site-specific amino-acid preferences are typically estimated either by penalized maximum likelihood~\citep{Tamuri2012,Tamuri2014}, or in a Bayesian context, using an infinite mixture based on a Dirichlet process prior~\citep{Rodrigue2010,Rodrigue2014}.
This second approach is further considered below.

Moreover, modelling explicitly purifying selection proved to be a valuable null (nearly-neutral) model~\citep{Spielman2015, DosReis2015}, against which to test for the presence of adaptation~\citep{Rodrigue2016,Bloom2017}.

However, these mutation-selection methods have so far assumed the strength of genetic drift, or equivalently $\Ne$, to be constant across the phylogeny.
This assumption is clearly not realistic, as attested by the empirically measured variation in $\dnds$ between lineages using classical codon models or, more directly, by the broad range of synonymous neutral diversity observed across species~\citep{Galtier2016}.
The impact of this assumption on the estimation of the fitness landscape across sites~\citep{Tamuri2014, Rodrigue2014}, or on the tests for the presence of adaptation~\citep{Rodrigue2016} is totally unknown.
Relaxing this assumption of a constant $\Ne$ is thus necessary.

Conversely, since the mutation-selection formalism explicitly incorporates $\Ne$ as a parameter of the model, extending the model so as to let $\Ne$ vary across lineages is relatively straightforward, at least conceptually.
Doing this would then provide an occasion to address several important questions: do we have enough signal in empirical sequence alignments, to estimate the evolutionary history of $\Ne$ along a phylogeny?
Can we more generally revisit the question of the empirical correlations between $\Ne$ and ecological life-history traits (longevity, maturity, weight, size, $\hdots$), previously explored using classical $\dnds$ based models, but now in the context of this mechanistic framework?


\section{New approaches}
\label{sec:NewApproaches}

To address these questions, here we introduce a variant of the mutation-selection codon models, in which selection is modulated along the sequence (using site-specific amino-acid profiles), while the mutation rate ($\mu$), the effective population size ($\Ne$) and life-history traits are allowed to vary along the phylogeny (figure~\ref{fig:modelSummary}).
Methodologically, our model is fundamentally an integration between the bayesian non-parametric version of the \citet{Halpern1998} mutation-selection model~\citep{Rodrigue2014}, and the molecular comparative framework modelling the joint evolution of life-history and molecular traits~\citep{Lartillot2011}.

\begin{figure}[htbp]
    \centering
    \includegraphics[width=\textwidth] {model_summary.pdf}
    \caption[Model summary]{
    Model summary.
    Panel A.
    Our method requires a given rooted topology, and an alignment of protein-coding \acrshort{DNA} for the extant species.
    Optionally, the method can use quantitative life-history traits at the leaves of the tree, and dated estimation for the internal nodes of the tree.
    Panel B.
    Our Bayesian inference model estimates selection coefficients, mutation rate, intensity of genetic drift and the age of the internal nodes.
    Effective population since~($\Ne$) and mutation rate per unit of time~($\mu$) are considered fluctuating branch-wise, but assumed constant across all sites of the \acrshort{DNA} sequence.
    Conversely, the selection coefficient of amino acids are considered changing for sites along the \acrshort{DNA} sequence, but are considered constant across the tree.
    Branch heterogeneity is modelled as an auto-correlated log-Brownian process, meaning our model estimates correlation coefficients between quantitative traits (as input), $\Ne$, and $\mu$, where phylogenetic inertia is accounted for.
    Synonymous substitutions are leveraged to estimates branch-wise mutation rate~($\mu$).
    Site-specific rates of non-synonymous substitutions across the tree is leveraged to estimate site-wise selection coefficient~($\Fit$).
    Branch-specific rates of non-synonymous substitutions across the sequence is leveraged to estimate branch-wise genetic drift~($\Ne$).
    }
    \label{fig:modelSummary}
\end{figure}

Formally, the substitution rate (per unit of time) from codon $\ci$ to $\cj$, denoted $\submatrix_{\itoj}$, is equal to the total rate of mutation (per unit of time) at the level of the population~($2\Ne\mu_{\itoj}$) multiplied by the probability of fixation of the mutation:
\begin{equation}
{\submatrix_{\itoj}}
    = 2 \Ne \mu_{\itoj} \pfix(\itoj)
\end{equation}
In the case of synonymous mutations, which we assumed are neutral, the probability of fixation is independent of the original and target codon, and equal $1/2 \Ne$, such that ${\submatrix_{\itoj}}$ simplifies to:
\begin{equation}
    \submatrix_{\itoj} = \mu_{\itoj}
\end{equation}
In the case of non-synonymous mutations, the probability of fixation depends on the difference in fitness~\citep{Ohta1992} between the amino acid encoded by the initial and final codons:
\begin{equation}
    \label{eq:mutationSelection}
    {\submatrix_{\itoj}} = \mu_{\itoj} \dfrac{4 \Ne \left({\fitj - \fiti}\right)}{{1 - \e^{4 \Ne \left({\fiti - \fitj}\right)} }}
\end{equation}
where $\Fit$ is a $20$-dimensional vector specifying the log-fitness for each amino acid, and $\aai$ is the amino acid encoded by codon $i$.

In the model introduced here, $\Ne$ and $\mu$ are allowed to vary between species (across branches) as a multivariate log-Brownian process, but are assumed constant along the DNA sequence.
Conversely, amino-acid fitness profiles $\Fit$ are considered constant along the tree but are assumed to vary across sites, being modelled as iid random-effects from an unknown distribution estimated using a Dirichlet process prior.

This model was implemented in a Markov chain Monte Carlo framework, allowing for joint inference of site-specific selection profiles and reconstruction of life-history traits and population-genetic regimes along the phylogeny.
After validating our model and our inference framework against simulated data, we apply it to several cases of interest across metazoans (placental mammals, primates, Drosophila and isopods), for which some proxies of $\Ne$ are available.


\section{Results}
\label{sec:Results}

\begin{figure}[htbp]
    \centering
    \begin{minipage}{0.32\linewidth}
        \includegraphics[width=\linewidth, page=1]{simulations/BranchWise_SimuDiv_SiteMutSelBranchNe_BranchCorrelation_Log10BranchLength}
    \end{minipage}
    \llap{\raisebox{-1.0cm}{\scriptsize A\hspace{0.35cm}}}\hfill
    \begin{minipage}{0.32\linewidth}
        \includegraphics[width=\linewidth, page=1]{simulations/SimuPoly_SiteMutSelBranchNe_BranchCorrelation_Log10BranchLength}
    \end{minipage}
    \llap{\raisebox{-1.0cm}{\scriptsize B\hspace{0.35cm}}}\hfill
    \begin{minipage}{0.32\linewidth}
        \includegraphics[width=\linewidth, page=1]{simulations/SimuFold_SiteMutSelBranchNe_BranchCorrelation_Log10BranchLength}
    \end{minipage}
    \llap{\raisebox{-1.0cm}{\scriptsize C\hspace{0.35cm}}}\hfill
    \begin{minipage}{0.32\linewidth}
        \includegraphics[width=\linewidth, page=1]{simulations/BranchWise_SimuDiv_SiteMutSelBranchNe_BranchCorrelation_LogPopulationSize}
    \end{minipage}
    \llap{\raisebox{-1.0cm}{\scriptsize D\hspace{0.35cm}}}\hfill
    \begin{minipage}{0.32\linewidth}
        \includegraphics[width=\linewidth, page=1]{simulations/SimuPoly_SiteMutSelBranchNe_BranchCorrelation_LogPopulationSize}
    \end{minipage}
    \llap{\raisebox{-1.0cm}{\scriptsize E\hspace{0.35cm}}}\hfill
    \begin{minipage}{0.32\linewidth}
        \includegraphics[width=\linewidth, page=1]{simulations/SimuFold_SiteMutSelBranchNe_BranchCorrelation_LogPopulationSize}
    \end{minipage}
    \llap{\raisebox{-1.0cm}{\scriptsize F\hspace{0.35cm}}}\hfill
    \caption[Inferred and simulated branch length and $\Ne$]{
    Inferred values in vertical axis against simulated value in horizontal axis.
    In the top row (panels A, B and C), branch length in expected number of substitutions for each branch of the tree.
    In the bottom row (panels D, E and F), $\Ne$ for each node (including leaves) of the tree, relative to $\Ne$ at the root of the tree.
    In the left panels (A and D), simulation under the mutation-selection approximation, as to test the soundness of the inference framework.
    In middle panels (B and E), simulation accounting for small population size effects~($5000$ individuals at the root), site linkage and short term fluctuation of $\Ne$.
    In the right panels (C and F), simulation accounting for site epistasis in context of selection for protein stability, with fluctuation of the selection coefficient along the phylogeny.
    The tree root is $150$ million years old, where the initial population start with a mutation rate of $\smash{1e^{-8}}$ per site per generation, and generation time of $10$ years.
    These experiments confirm that signal in the placental mammalian tree can allow to reliably infer the direction of change in $\Ne$, even if linkage disequilibrium, short term fluctuation of $\Ne$ and finite population size effects are not accounted for in the inference framework.
    However, the presence of epistasis between sites is a serious threat to the inference of $\Ne$.
    }
    \label{fig:simulations}
\end{figure}

\subsection{Validation using simulations}
\label{sec:ResultsSimulated}
The inference framework was first tested on independently simulated multiple sequence alignments (see Methods).
With the aim of applying the inference method to empirical dataset, the simulation parameters were chosen so as to match an empirically relevant empirical regime.
Thus, the tree topology and the branch lengths were chosen based on a tree estimated on the mammalian dataset further considered below.
The other aspects of the simulation model (fitness landscape, variation in $\Ne$) were then varied along a gradient of increasing complexity, so as to test the inference framework under increasingly challenging conditions.

A first series of simulations was meant to test the soundness of our inference framework, by simulating essentially under the model used for inference, although with an independently developed software.
Thus, the mutation-selection approximation was assumed to be valid, and sites were simulated under different fitness profiles empirically determined~\citep{Bloom2017}), and finally, $\Ne$ was assumed to undergo discrete shifts at the tree nodes but otherwise to remain constant along each branch.
In this context, branch lengths and branch-specific values of $\Ne$ were accurately estimated by our inference method (figure~\ref{fig:simulations}, panel A \& D).
Concerning $\Ne$, the slope of the linear regression between true and estimated branch-specific $\Ne$ is $0.794$ ($r^2=0.915$)

However, the assumptions made for this first round of simulations are almost certainly violated in practice.
First, $\Ne$ is expected to undergo continuous changes along the lineages of the phylogeny.
Second, the diffusion approximation for the probability of fixation (equation~\ref{eq:mutationSelection}) may not hold in small finite populations.
Third, assuming a separate substitution process for each site is equivalent to assuming no linkage between sites (free recombination)
In practice, however, there is limited recombination, at least within exons, and this could induce deviations from the mutation-selection approximation, due to Hill-Robertson effects.

The finite population was now modelled explicitly, using a Wright-Fisher simulator, tracking the frequency of each allele at the gene level and at each generation along the phylogeny.
No recombination was implemented within genes.
These more complex simulation settings account for small population size effects, for hitchhiking of weakly deleterious mutations during selective sweep and for background selection due to linkage disequilibrium.
In addition, the effective population size $\Ne$ and The mutation rate were allowed to fluctuate continuously along the branches of the tree (changing by a small amount after each generation of the underlying Wright-Fisher process).
Finally, short-term fluctuations of $\Ne$, of the order of 20\% per generation, were accounted for by adding a random noise to the brownian process describing the long-term evolution of $\Ne$.
In spite of these deviations between the simulation and the inference models, branch lengths and branch-specific effective population sizes could again be robustly recovered by the inference framework (slope of $0.868$, $r^2=0.919$, figure~\ref{fig:simulations}, panel B \& E).

These results are encouraging.
However, they still rely on the assumption of a site-independent fitness landscape, which is equivalent to assuming no epistasis.
Yet this assumption almost certainly violated in practice~\citep{Pollock2014,Shah2015}.
Accordingly, we implemented a more complex, site-dependent fitness landscape accounting for the selective interactions between sites induced by the 3-dimensional structure of protein.
In this model, the conformational stability of the protein determines its probability of being in the folded state, which is in turn taken as a proxy for fitness~\citep{Williams2006, Goldstein2011, Pollock2012}.
Under this evolutionary model, and at any gven time, the fitness landscape at a particular codon site is dependent on the amino acids that are currently present at those sites that are in the vicinity of the focal site in 3D space (see section~\ref{subsec:protein-folding-probability} in supplementary materials).
WHen applied to data simulated using this model, our inference framework could accurately recover the simulated branch lengths (figure~\ref{fig:simulations}, panel D).
On the other hand, the distribution of $\Ne$ across the tree could not be accurately recovered (slope of $0.0196$, $r^2 = 0.0122$, figure~\ref{fig:simulations}, panel F).
In fact, no meaningful variation in $\Ne$ is detected, and the little variation in $\Ne$ that is inferred shows no correlation with the true branch-specific mean $\Ne$ values.
This effect can be explained by the predicted independence of $\dnds$, and more generally of the scaled selection coefficients associated with non-synonymous mutations, to changes in $\Ne$ in this specific model of protein stability, as shown theoretically by \citet{Goldstein2013}.

As an alternative model of epistasis between sites, a Fisher geometric model was also considered for the simulations (see supplementary materials, section~\ref{subsec:fisher-geometric-landscape}).
The results under this model are intermediate between simulations without epistasis and simulations under the biophysically-inspired model considered above.
More specifically, under data simulated using Fisher’s geometric model, the true and estimated branch-specific $\Ne$ are relatively strongly correlated with each other ($r^2 = 0.73$).
On the other hand, the slope of the correlation is substantially less than 1 ($0.571$).
In other words, the trends in $\Ne$ across the tree are correctly recovered, but the range of the variation in effective population size over the tree is substantially under-estimated.
As for the branch lengths, they are again correctly estimated.
In summary, our simulation experiments show that our inference framework is reliable in the absence of model mis-specification and is robust to violations concerning short-versus long-term variation in $\Ne$ or to the presence of empirically reasonable levels of Hill-Robertson interference.
On the other hand, and very importantly, epistasis, which is ignored by the inference model, appears to lead to a general underestimation of the true variation in Ne, to an extent that depends on the exact epistatic model but can go as far as completely obliterating any signal about the true variation in $\Ne$ across the tree in the most extreme situations.

\subsection{Empirical experiments}
\label{sec:ResultsEmpirical}
\begin{figure}[htbp]
    \centering
    \begin{minipage}{0.411\linewidth}
        \includegraphics[valign=t, width=\linewidth, page=1, clip, trim=0cm 0cm 15.35cm 0.15cm]{mammals/18CDS_SiteMutSelBranchNe_R1_LogPopulationSize}
    \end{minipage}
    \begin{minipage}{0.159\linewidth}
        \includegraphics[valign=t, width=\linewidth, page=1, clip, trim=0cm -2.25cm 0cm 0cm]{mammals_species}
    \end{minipage}
    \begin{minipage}{0.411\linewidth}
        \reflectbox{\includegraphics[valign=t, width=\linewidth, page=1, clip, trim=0cm 4.48cm 15.35cm 0cm]{mammals/18CDS_SiteMutSelBranchNe_R1_LogMutationRatePerTime}}
        \includegraphics[valign=b,width=\linewidth, page=1, clip, trim=0cm 0cm 15.35cm 32.3cm]{mammals/18CDS_SiteMutSelBranchNe_R1_LogMutationRatePerTime}
    \end{minipage}
    \caption[Example of inferred $\Ne$ and $\mu$ on placental mammals dataset]{
    Example of inferred $\Ne$ and $\mu$ on placental mammals dataset.
    Inferences were performed on a randomly chosen set of $18$ coding sequences (\acrshort{CDS}) out of $226$ highly conserved CDS~($<1\%$ of gaps).
    Only highly conserved \acrshort{CDS} were retained such that the assumption of constant fitness landscape is not incautiously broken by protein with changing function and/or adaptive selection.
    Brownian processes along the tree are represented for effective population size~($\Ne$, left panel) and mutation rate per site per unit of time~($\mu$, right panel).
    Mean values of \acrshort{MCMC} (after burn-in) are obtained at each node of the tree, hence a gradient can be extrapolated along each branch.
    At each node, the inner circle represents the lower bound of the \acrshort{MCMC} $90\%$ confidence interval, and the outer circle represent the upper bound, as to give visual input into the range of estimation.
    $\mu$ spanned almost $2$ order of magnitude, and if we assume the root to be $105$My old~\citep{Kumar2017}, the rescaled mutation rate per site per year in extant species is between $\smash{1.1e^{-10}}$ and $\smash{7.8e^{-9}}$.
    $\Ne$ at the root of the tree is arbitrarily set to $1$, and all values are relative to the root.
    }
    \label{fig:mammals_popsize_and_mutrate}
\end{figure}

We next applied our inference framework to a series of 4 empirical datasets spanning different taxnonomic groups within metazoans.
As a first empirical case, we considered a dataset of 77 placental mammals, for which complete genome sequences and information about life-history traits is available.
Placental mammals offer an interesting example, for which effective population size is likely to show substantial variation across lineages.
This variation in $\Ne$ is expected to covary with life-history traits (LHTs), such that large-bodied species are expected to have smaller effective population sizes, compared to small-bodied species.
Placental mammals thus offer an interesting case study on which to apply our model.

For computational reasons, we restricted our analyses to small concatenates made of 18 randomly sampled alignments of orthologous genes.
To assess the reproducibility of our inference and check that the signal about variation in $\Ne$ is not driven by particular genes, we analysed several concatenated random samples of 18 genes (figure 8.4 -> supp info).
In addition, since the mutation-selection model considered here assumes a mostly nearly-neutral regime, genes for which positive selection was detected using a site codon model were excluded (see methods).

The reconstructed long-term changes in effective population size ($\Ne$) is displayed in figure~\ref{fig:mammals_popsize_and_mutrate}.
We visually observe a global trend of increased $\Ne$ throughout the tree around 90 and 60 My.
We also observe $\Ne$ to be lower in some clades, such as \textit{cetacea} and \textit{camelidae}, while being higher in other clades, such as \textit{rodentia} and \textit{pecora}.
In some cases, a decrease in $\Ne$ can be observed along an isolated branch of the tree, for example on the branches leading to the naked mole-rat (\textit{Heterocephalus glaber}) or to the cheetah \textit{Acinonyx jubatus}.

The estimated covariance matrix (table~\ref{fig:mammals_correlation}) gives a global synthetic picture about the patterns of covariation between the mutation rate per unit of time mu, the effective population size $\Ne$ and the three LHTs.
First, the variation in $\mu$ across species is negatively correlated with variation in body mass, age at sexual maturity and longevity (table~\ref{fig:mammals_correlation}).
These correlations, which were previously reported (REFS) probably reflect generation time effects (REFS).
Similarly, and more interestingly in the present context, the variation in $\Ne$ between species is also negatively correlated with LHTs ($\rho=$)
This is consistent with the expectation that small-sized and short-lived species tend to be characterized by larger effective population sizes (REFS).
Of note, these results mirror previous findings, based on classical codon models, showing that $\dnds$ tends to be positively correlated with LHTs~\citep{Romiguier2014,Galtier2016}(REFS).
Finally, $\Ne$ and the mutation rate are positively correlated in their variation ($\rho = 0.44$), which might simply reflect the fact that both negatively correlate with LHTs.
The partial-correlation coefficients (see definition section~\ref{subsec:partial-correlation-coefficient} and table~\ref{tab:table-partcor-mammals} in supplementary materials) are not significantly different from 0.
However, this might simply be due to the very strong correlation between the three LHTs considered here (minimum $\rho$ is $0.827$), such that controlling for any one of them removes most of the signal contributed by the available empirical variation between species.

Thus, altogether, the inferred trends in $\Ne$ across species appear to be as expected, based on considerations about life-history evolution.
On the other hand, the total range of the inferred variation in $\Ne$ across the entire tree is surprisingly narrow, with a ratio of $2.5$ between the maximum and minimum inferred $\Ne$ among extant species (see figure~\ref{fig:mammals_popsize_and_mutrate}).
This almost certainly represents an underestimate of the true range of variation across placental mammals.

As another case study, we analysed a group of isopod species that have made multiple independent transitions to subterranean environments.
Protein coding DNA sequences alignment and qualitative life-history traits such as habitat (surface or underground), pigmentation (depigmented, partially depigmented or pigmented) and ocular structure (anophthalmia, microphthalmia, or ocular) are available for these species~\citep{Eme2013,Saclier2018}.
%-> donner plus de contexte ici, sur la base des articles de tristan.
The transition from a terrestrial to a subterranean lifestyle is typically associated with a global life-history and ecological syndrome characterized by a loss of vision, longer generation times and, most interestingly, smaller population sizes, due to a lower carrying capacity of the subterranean environment~\citep{Capderrey2013}.
Of note, the assumption of a Brownian autocorrelated process for describing the changes in $\Ne$ along the tree may not be so well adapted to the present case, since the changes in effective population size associated with the transition to a subterranean environment are likely to correspond to relatively sudden shifts, rather than continuous variation, and the ecological correlate (subterranean versus terrestrial) is not a quantitative trait.
However, the dataset considered here contains independent transitions to a subterranean lifestyle, thus offering an opportunity to test for a potential correlation between inferred $\Ne$ variation and terrestrial versus subterranean lifestyles over the terminal branches (ref Tristan ou Nathanaelle).
Estimation of $\Ne$ reveals a correlation between qualitative life-history traits and Ne, presented section~\ref{sec:empirical-data-in-isopods} in supplementary materials.
% -> décrire brièvement la variation de $\Ne$ à travers l’arbre.
% meriterait d’être un résultat présenté dans le main text de l’article, non ?
% et bien montrer la tendance: d’une diminution du $\Ne$ estimé chez les espèces souterraines. histoire quand même d’avoir tout raconté à ce sujet.
% redonner ici une evaluation du range de variation à travers la phylogénie.

Next, our empirical framework was also applied on a primate dataset, presented section~\ref{sec:empirical-data-in-primates} in supplementary materials.
Reconstructed $\Ne$ and $\mu$ are related to LHT (mass, female maturity, generation time and longevity), synonymous diversity ($\ps$) and non-synonymous over synonymous ($\pnps$).

% -> développer un peu: jeu de données intéressant parce que piS and piN/piS: based on pop gen theory, ces deux variables are expected to directly correlate with $\Ne$~\citep{Eyre-walker2007, Galtier2016}.
% Sont disponibles pour 10 espèces de primates à travers le jeu de données.
% Donne une occasion d’appliquer le modèle comparatif moléculaire, pour tester si notre inferred $\Ne$ correlates with $\ps$ and $\pnps$ as expected.
% -> résultats.
% La aussi, description rapide sur l’arbre (relis notre article avec Mathieu, pour comparer), donner le range, puis parler des corrélations.

Finally, our empirical framework was also applied in Drosophila and related to genome size, presented section~\ref{sec:empirical-data-in-primates} in supplementary materials.
% "and related to genome size »: pourrais peut-être prendre le temps d’introduire (brièvement, mais quand même en plus que 5 mots!) la problématique de Ne/genome size?..
% These experiments, however, did not uncover statistically significant correlation between $\Ne$ and genome size ($r^2=$).
% -> là aussi développer.

\begin{table}[htbp]
    \input{mammals/18CDS_SiteMutSelBranchNe_R1_TraitsCorrelation.tex}
    \caption[Traits correlation]{
    Correlation coefficient between effective population size~($\Ne$), mutation rate per site per unit of time~($\mu$), and life-history traits (Maximum longevity, adult weight and female maturity), taking account phylogenetic inertia.
    Correlation coefficients are between $-1$ and $1$.
    Asterisks indicate strength of support of the posterior probability to be different than $0$ (pp) as $\smash{^{*}} pp > 0.95$ and $\smash{^{**}} pp > 0.975$.
    Observed correlations are compatible with the interpretation that large populations are composed of small, short-lived individuals.
    Moreover if the mutation rate per generation is considered constant in first approximation, the mutation rate per unit of time is positively correlated to generation rate, hence to population size.
    }
    \label{fig:mammals_correlation}
\end{table}

\section{Discussion}
\label{sec:Discussion}
% Summary 
Mechanistic phylogenetic codon models explicitly model the substitution rates between codons as function of the mutation rates at the nucleotide level, selection over amino-acid sequences and effective population size.
Thus far, the development of mutation-selection models of the HB family~\citep{Rodrigue2010, Tamuri2012} has mostly focussed on the question of fully accounting for the fine-scale modulations of selection between amino-acids and across sites~\citep{Rodrigue2010, Tamuri2012}.
However, the issue of the variation in the global population-genetic regime between species has received much less attention.
In particular, effective population size ($\Ne$) is expected to vary substantially over the species of a given clade, yet current mutation-selection models all invariably assume $\Ne$ to be constant across the phylogeny.

Here, we introduce an extension of the mutation-selection model that accounts for this variation.
When applied to an alignment of protein coding sequences, this mechanistic model returns an estimate of the modulations of amino-acid preferences across sites.
Simultaneously, it reconstructs the joint evolution of life-history traits and molecular and population-genetic parameters (mutation rate $\mu$ and effective population size $\Ne$) along the phylogeny, while estimating the correlation matrix between these variables, intrinsically accounting for phylogenetic inertia.

\subsection{Reliability of the inference of the phylogenetic history of \texorpdfstring{$\Ne$}{Nₑ}}.

The reconstructions obtained on several empirical datasets, in particular in mammals and in isopods, suggest that the method is able to correctly infer the directional trends of the changes in $\Ne$ across species.
In particular, in mammals, the inferred variation in $\Ne$ correlates negatively with body size and, more generally, with life-history traits, as expected under the reasonable assumption that large-bodied mammals would tend to have smaller effective population sizes~\cite{Popadin2007,Lartillot2012,Nabholz2013,Figuet2017}.
Similarly, in isopods, smaller effective population sizes are inferred in subterranean species, again, as expected~\citep{Capderrey2013}.

However, if the trends are in right direction, the magnitude of the changes inferred across the phylogeny is greatly inferior to the expected variation.
In particular, in mammals, synonymous diversity varies by a factor at least 10 between species~\citep{Galtier2016}.
In animals, the synonymous diversity roughly spans two orders of magnitude, whereas $\Ne$ varies considerably more across species, by a factor of $10^3$~\citep{Galtier2019}.
For instance, effective population sizes estimated based on population genomic data are of the order of 10~000 in Humans~\citep{Li2011}, and 100~000 in the mouse~\citep{Geraldes2008}.
Thus, clearly, our approach underestimates the true variation.
Different mechanisms not accounted for by the model could explain such a low variation in the phylogenetic history of $\Ne$ reconstructed by our method.

First, genetic hitchhiking, Hill-Robertson interference, and short-term fluctuations of $\Ne$ could generate this effect.
However, inference conducted on alignments simulated under a Wright-Fisher model accounting for linkage and for short-term variation in $\Ne$ tends to show that this effect is not strong enough to explain this observation, at least in the regimes explored.

Second, $\mu$ and $\Ne$ could also be fluctuating along the genome (REFS).
This assumption needs to be tested, though we expect that relaxing this assumption would not change drastically the magnitude of inferred $\Ne$ since some of this fluctuation should be absorbed by site-specific fitness profiles.

Third, the DNA sequences could also be misaligned at some sites.
However we observe the same magnitude of inferred $\Ne$ for different set of genes indicating this might not be the primary reason.

Fourth, the genes selected in our alignments could be under adaptive evolution, or their function could have changed.
However, at least in mammals, the impact of this potential problem was minimized by the use of genes for no positive selection was detected using standard phylogenetic codon site models.

Finally, one key assumption of the mutation-selection model that is likely to be violated in practice is the assumption of site-independence.
In reality, epistasis might be prevalent in protein coding sequence evolution~\citep{Pollock2014,Shah2015}.
Our simulations under an epistatic landscape point to epistasis being a major factor to be investigated.
Indeed, $\Ne$ could not be appropriately estimated under these simulation settings, although the outcome more specifically depends on the exact model for the fitness landscape.
An extreme case is obtained using a biophysically-inspired model, assuming purifying selection for conformational stability.
This model was previously explored using simulations and theoretical developments \citet{Goldstein2013}, and it was shown that, under this model, the $\dnds$ and more generally the substitution process is virtually insensitive to Ne.
This is confirmed by our experiments, showing that the mutation-selection approach explored here cannot infer the true variation in $\Ne$ under this model.

A less extreme outcome is obtained under an alternative model also implementing epistatic interactions between sites, Fisher’s geometric model~\citep{Tenaillon2014,Blanquart2016}.
Interestingly, under this model, our inference framework is able to infer the correct trends of $\Ne$, although with a substantially underestimated range of inferred variation, thus mirroring the results obtained on placental mammals.
Of note, these results do not necessarily imply that models based on biophysics are empirically less relevant than Fisher’s geometric model.
Instead, they might just betray that the response of the substitution process to changes in $\Ne$ may be sensitive to the exact quantitative details of the underlying fitness landscape.
More work is probably needed here to characterize these exact conditions.
Nevertheless, our simulation experiments suggest a global pattern: epistatic interactions induce a buffering of the response of the substitution process to changes in $\Ne$.
The meaningful correlation patterns observed with LHTs in the case of placental mammals suggest that this buffering is not complete.
Nevertheless, ignoring epistatic interactions at the inference level appears to result in a substantial underestimation of the range over which $\Ne$ varies across species.

Interestingly, the magnitude of the inferred range of $\Ne$ variation is even smaller for the placental than the primate datasets (x$2.5$ in mammals and x$7.0$ in primates), whereas we would have expected a broader range of variation over the broader phylogenetic scale of placental mammals, compared to primates.
An explanation could be that epistasis is more prevalent at longer time-scale.
Indeed, the total number of substitutions from root to leaves is greater, and as a result, the local environment, and therefore the fitness landscape at the level of each site, has been less stable across the phylogeny.

Although modelling epistasis in an inference framework is a complex biological, mathematical and computational problem, our work points to a potential signal of epistasis that could be retrieved in phylogenetic context.
More specifically, since the slope of the response of the substitution process to changes in $\Ne$ appears to be informative about the epistatic regime, then, conversely, by relying on independent estimates of $\Ne$ (e.g. using polymorphism), this effect could be used to leverage a quantitative estimate of the statistical distribution of epistatic effects.

Other methods have recently been developed to reconstruct phylogenetic changes in $\Ne$.
For example, a method recently developed uses polymorphism and generation time for some present-day species to reconstruct $\Ne$ along the phylogeny, based on a classical ($\dnds$-based) codon model~\citep{Brevet2019}.
This method implicitly relies on a nearly-neutral model, assuming a fixed and gamma-shaped distribution of fitness effects across non-synonymous mutations.
The approach is calibrated using fossils, and as a result, returns estimates of the absolute value of $\Ne$ and of its phylogenetic variation.
Here, in contrast, our method requires neither generation times nor polymorphism data, and the fitness effects are not constrained to a specific distribution.
On the other hand, the inferred effective population sizes are only relative.
In addition, the empirical fitting of the model requires more computing resources.

\subsection{Potential applications and future developments}

Apart from reconstructing the phylogenetic history of $\Ne$ and investigating its causes and covariates, another potentially interesting application of our approach is in detecting adaptation.
In this direction, mutation-selection models represent a useful null nearly-neutral model, explicitly modelling the background of purifying selection acting over protein coding genes.
Adaptation can then be detected by measuring the deviation from this null model~\citep{Rodrigue2016, Bloom2017}.

However, by assuming constant $\Ne$ along a phylogeny, the statistical power of this approach to detect sites under adaptive evolution may not be optimal.
In particular, the site-specific fitness profiles inferred by the model are averaged along the phylogeny and are seemingly more diffuse than those estimated profiles under our present framework (see section~\ref{subsec:fitness-profile-entropy} and table~\ref{tab:table-entropy-aa-mutselne} in supplementary materials).
Thus, even though our method requires more computing resources, it should provide a better null model of purifying selection against which to test for the presence of adaptive evolution.

The approach can be further extended in other directions.
First, currently, our model also assumes no selection on codon usage.
In the case of primates or placental mammals, this assumption is probably reasonable~\citep{Yang2008}, although it is more questionable for other groups, in particular Drosophila~\citep{Duret1999,Plotkin2011}.
In principle, this assumption can be relaxed by implementing selective codon preferences that are shared across all sites.
Such an implementation would provide the advantage of estimating codon usage biases, while simultaneously accounting for its confounding effect when estimating selection on amino-acids and inter-specific variation in $\Ne$.

Second, the bayesian analysis conducted here was based on relatively small alignments (20,000 sites at most), and with strong limits on the parametrization of the underlying mixture model (allowing for at most 50 distinct profile categories).
Profiling of the program (not shown) shows that the number of components of the profile mixture is the limiting step of the computation.
Yet, a larger number of components might be required, in order to achieve more accurate inference of the site-specific profiles.
One possible development, leading to statistically more stable genome-wide estimates of $\Ne$, would be to develop a multi-gene parallelized version of the model, in which each coding sequence would have its own mixture model, and would run on a separate thread, while the history of $\Ne$ would be shared by all computing processes.

Finally, estimating $\Ne$ in a mutation-selection phylogenetic model relies on the relation between $\ne$ and the relative strength of drift, in a context where, ultimately, the signal about the intensity of drift comes from the relative rate of non-synonymous substitutions.
However, this purely phylogenetic approach does not leverage a second aspect of $\Ne$ at the population level, namely, the fact that $\Ne$ also determines the levels of neutral genetic diversity that can be maintained ~($\pi=4\Ne u$, where $u$ is the mutation rate per generation).
Hence, neutral diversity yields an independent empirical estimate of $\Ne$.
In principle, our mechanistic model could be extended so as to incorporate polymorphism data within species at the tips of the phylogeny.
A similar method has been previously pioneered in the case of 3 species and using a distribution of fitness effect\citep{Wilson2011}.
More generally, the nearly-neutral theory of evolution defines a long-term $\Ne$, which might be different from the short-term definition of $\Ne$~\citep{Platt2018}.
Thus we could ask if empirical independent estimations of $\Ne$ from within species (based on genetic diversity) and between species (based on the substitution process) are congruent, and if not what are the mechanisms responsible for this discrepancy.

Notwithstanding theoretical considerations on the nearly-neutral theory of evolution, empirical clues about the long-term trends in the modulations of the intensity of genetic drift opens towards a large diversity of ecological and evolutionary questions.
Spatial and temporal changes of genetic drift along ecological niches and events can now be investigated, so as to disentangle the underlying evolutionary and ecological pressures.

\begin{figure}[htbp]
    \centering
    \begin{minipage}{0.32\linewidth}
        \includegraphics[width=\linewidth, page=1]{mammals/18CDS_SiteMutSelBranchNe_Rep_Log10BranchLength-1-2}
    \end{minipage}
    \llap{\raisebox{-1.0cm}{\scriptsize A\hspace{0.35cm}}}\hfill
    \begin{minipage}{0.32\linewidth}
        \includegraphics[width=\linewidth, page=1]{mammals/18CDS_SiteMutSelBranchNe_Rep_Log10BranchLength-1-3}
    \end{minipage}
    \llap{\raisebox{-1.0cm}{\scriptsize B\hspace{0.35cm}}}\hfill
    \begin{minipage}{0.32\linewidth}
        \includegraphics[width=\linewidth, page=1]{mammals/18CDS_SiteMutSelBranchNe_Rep_Log10BranchLength-1-4}
    \end{minipage}
    \llap{\raisebox{-1.0cm}{\scriptsize C\hspace{0.35cm}}}\hfill
    \begin{minipage}{0.32\linewidth}
        \includegraphics[width=\linewidth, page=1]{mammals/18CDS_SiteMutSelBranchNe_Rep_LogPopulationSize-1-2}
    \end{minipage}
    \llap{\raisebox{-1.0cm}{\scriptsize D\hspace{0.35cm}}}\hfill
    \begin{minipage}{0.32\linewidth}
        \includegraphics[width=\linewidth, page=1]{mammals/18CDS_SiteMutSelBranchNe_Rep_LogPopulationSize-1-3}
    \end{minipage}
    \llap{\raisebox{-1.0cm}{\scriptsize E\hspace{0.35cm}}}\hfill
    \begin{minipage}{0.32\linewidth}
        \includegraphics[width=\linewidth, page=1]{mammals/18CDS_SiteMutSelBranchNe_Rep_LogPopulationSize-1-4}
    \end{minipage}
    \llap{\raisebox{-1.0cm}{\scriptsize F\hspace{0.35cm}}}\hfill
    \caption[Repeatability of experiments]{
    Repeatability of experiments.
    $3$ independent inferences were performed on a randomly chosen set of $18$ coding sequences (\acrshort{CDS}) out of $226$.
    Each plot is a correlation between a pair of experiments for a given parameter.
    Mutation rate per unit of time~($\mu$), is represented in the top row (panels A, B and C), while effective population size~($\Ne$) is represented in the bottom row (panels D, E and F).
    For each node of the tree, the mean posterior of the parameter~($\Ne$ or $\mu$) over the \acrshort{MCMC} (after burn-in) is represented in blue dots, green solid lines are the $90\%$ confidence interval of the \acrshort{MCMC}.
    Solid red line is the regression line between experiments.
    Inference of $\mu$ is more reproducible than $\Ne$, but overall the experiment is reproducible for a random subset of \acrshort{CDS}.
    }
    \label{fig:mammals_repeatability}
\end{figure}

\section{Materials and Methods}
\label{sec:MatMet}

In the model presented here, $\Ne$ and $\mu$ are allowed to vary between species (across branches) as a multivariate log-Brownian process, but assumed constant along the \acrshort{DNA} sequence.
In a multivariate log-Brownian process, traits are modelled together as a vector-valued time-dependent random process, parameterized by a covariance matrix between traits~($\Covariancematrix$).
Altogether, values of the multivariate process at each node of the tree, a covariance matrix and divergence times are jointly estimated.
Once the traits are sampled at all nodes, traits along each branch is taken as the average between extremities of this branch.
Technically, the precision matrix (invert of covariance matrix) is distributed as an invert Wishart, meaning the prior matrix is diagonal, pushing the correlation coefficients between traits toward $0$.
The work presented here implemented the branch heterogeneity in a Bayesian context, as in \texttt{CoEvol}~\citep{Lartillot2011}.
Conversely, amino-acid fitness profiles $\Fit$ are assumed to vary across sites, but are considered constant along the tree.
The work presented here relies on the Bayesian nonparametric random-effect approach, developed to estimate site-heterogeneous amino-acid fitnesses as in \texttt{PhyloBayes}~\citep{Rodrigue2010}.
Our Bayesian implementation, written in \texttt{C++} in the software \texttt{BayesCode}, is publicly available at \url{https://github.com/ThibaultLatrille/bayescode}.

The phylogenetic codon model presented here makes several additional assumptions on the evolutionary processes generating the observed alignment.
First, the species tree topology is supposed to be known, and each gene should match the species tree, meaning genes are strict orthologs (no paralogs and no horizontal transfers).
Second, there is no epistasis (interaction between sites), such that any position of the sequence has its own independent evolutionary process and a substitution at one position does not affect the substitution process at other positions.
Third, from a population genetics perspective, we assumed sites of the protein to be unlinked, or equivalently the mutation rate is low enough such that there is no Hill-Robertson interference nor genetic hitchhiking.
Fourth, we assume \acrshort{DNA} sequences to be representative of the species, not taking into account the sampling effect tending to over-represent weakly deleterious mutations present at low frequencies.

The parameterization of the models is described as a Bayesian hierarchical model, containing the prior distributions and parameters of the model.
This hierarchical model is formally represented as directed acyclic graph, depicted in figure~\ref{fig:DAG-MutSelNe}.

\subsection{Nucleotide mutation rates}
The generalized time-reversible nucleotide mutation rate matrix $\Mutmatrix$ is a function of the nucleotide frequencies $\Mutequi$ and the symmetric exchangeability rates $\Exchan$~\citep{Tavare1986}.
$\Mutequi = (\mutequi_A , \mutequi_C , \mutequi_G , \mutequi_T)$ is the equilibrium base frequency vector, giving the frequency at which each base occurs at each site.
$\Exchan = \left( \exchan_{AC}, \exchan_{AG}, \exchan_{AT}, \exchan_{CG}, \exchan_{CT}, \exchan_{GT}\right)$ is the vector of exchangeabilities between nucleotides.
Altogether, the rate matrix is:
\begin{equation}
    \label{eq:gtr-mutrates}
    \Mutmatrix =
    \begin{blockarray}{ccccc}
        & A & C & G & T \\
        \begin{block}{c(cccc)}
            A & - & {\exchan_{AC}\mutequi_C} & {\exchan_{AG}\mutequi_G} & {\exchan_{AT}\mutequi_T} \\
            C & {\exchan_{AC}\mutequi_A} &                        - & {\exchan_{CG}\mutequi_G} & {\exchan_{CT}\mutequi_T} \\
            G & {\exchan_{AG}\mutequi_A} & {\exchan_{CG}\mutequi_C} &                        - & {\exchan_{GT}\mutequi_T} \\
            T & {\exchan_{AT}\mutequi_A} & {\exchan_{CT}\mutequi_C} & {\exchan_{GT}\mutequi_G} & - \\
        \end{block}
    \end{blockarray}
\end{equation}
By definition, the sum of the entries in each row of the nucleotide rate matrix $\Mutmatrix$ is equal to $0$, giving the diagonal entries:
\begin{equation}
    \mutmatrix_{a,a} = - \sum\limits_{ b \neq a} \mutmatrix_{a,b}
\end{equation}
The prior on the exchangeabilities $\Exchan$ is a uniform Dirichlet distribution of dimension $6$:
\begin{equation}
    \label{eq:DistribExchan}
    \Exchan \sim \text{Dir}\left( \dfrac{1}{6} , 6\right).
\end{equation}
The prior on the equilibrium base frequencies $\Mutequi$ is a uniform Dirichlet distribution of dimension $4$:
\begin{equation}
    \label{eq:DistribMutequi}
    \Mutequi \sim \text{Dir}\left( \dfrac{1}{4} , 4\right)
\end{equation}
The general time-reversible nucleotide matrix is normalized such that the total flow equals to $1$:
\begin{equation}
    \sum\limits_{a \in \{A, C, G, T\}} - \mutequi_a \mutmatrix_{a,a} = 1.
\end{equation}

\subsection{Site-dependent selection}
\label{sec:profiles}
For each category $\Setcat$, a $20$-dimensional fitness profile $\Profile\catexp$ (summing to $1$) is distributed as a Dirichlet of center $\centerProfile$ and concentration $\concentrationProfile$:
\begin{equation}
    \label{eq:DistribBase}
    \Profile\catexp \sim \text{Dir}\left( \centerProfile,\ \concentrationProfile \right),\ \Setcat.
\end{equation}
For an alignment of size $\Nsite$, each site $\Setsite$ is assigned a fitness profile category of amino acids $\catsite \in \catInterval $.
The total number of sites falling in each fitness profile category $\cat$ is denoted $\catmultivar_{\cat}$.
The $\Ncat$-dimensional vector $\catMultiVar$ is distributed as a multinomial of event probabilities $\StickBreaking$:
\begin{align}
    \label{eq:DistribMultinomial}
    \catMultiVar \sim \text{Multinomial}\left( \StickBreaking \right).
\end{align}
The event probabilities $\Ncat$-dimensional vector~($\StickBreaking$) of falling into each category is distributed as a stick-breaking \gls{Dirichlet process}:
\begin{align}
    \label{eq:DistribStickBreaking}
    \begin{split}
        & \StickBreaking \sim \text{StickBreaking}\left( \Ncat, \stickbreakinghyper \right)\\
        \iff & \stickbreaking_{\cat} = \stick_{\cat}\cdot \prod _{{\indice=1}}^{{\cat-1}}\left(1-\stick_{\indice}\right),\ \Setcat,
    \end{split}
\end{align}
where $\stick_{\cat}$ are i.i.d.
from a beta distribution
\begin{equation}
    \label{eq:Beta}
    \stick_{\cat} \sim \text{Beta}\left( 1, \stickbreakinghyper \right),\ \Setcat.
\end{equation}
The Malthusian fitness selection coefficients $\Fit\siteexp$ at site $\site$, are obtained by taking the logarithm of the fitness profile assigned to this site:
\begin{equation}
    \label{eq:sitefitness}
    \Fit\siteexp = \ln \left( \Profile^{\left( \catsite \right)} \right),\ \Setsite.
\end{equation}

\subsection{Dated tree}
The topology of the rooted phylogenetic tree is supposed to be known and is not estimated by the model.
The model estimates the dates at which branches split, thus the dated tree requires $\Ntaxa - 2$ internal node ages that are free parameters, where $\Ntaxa$ is the number of extant taxa (leaves of the tree).
The node ages $\age\nodeexp,\ \Setinternal$ are drawn uniformly such that a node cannot be younger than the oldest of its $2$ descendant children, and must also be younger than its parent:
\begin{equation}
    \label{eq:Distribage}
    \age\nodeexp \ \sim \mathcal{U}\left( \text{max}\left(\age^{(\text{children})} \right), \age^{(\text{parent})} \right)
\end{equation}
By definition, leaf ages are all set to $0$. The root age is set arbitrarily to $1$, but if fossils data are also available the dated tree can be rescaled into absolute time using cross-multiplication.\\
The duration of the branch~($\branchtime\branchexp$), for each branch $\Setbranch$ is defined as the difference in ages between the oldest node at the tip of the branch $\age^{(\nodeUp)}$, and the youngest node $\age^{(\nodeDown)}$:
\begin{equation}
    \label{eq:ageTobranchtime}
    \branchtime\branchexp = \age^{(\nodeUp)} - \age^{(\nodeDown)}.
\end{equation}

\subsection{Branch dependent traits}
The effective population size $\Ne$ and mutation rate per unit of time $\mu$ are assumed to evolve along the phylogeny, and to be correlated.
If quantitative life-history traits (\acrshort{LHT}) are also available for some nodes of the tree (leaves and/or internal nodes), they are also assumed to evolve along the phylogeny and to be correlated between them, and with $\Ne$ and $\mu$.
The total number of traits (counting $\Ne$, $\mu$ and all user-defined LHT) is denoted $\Ntrait$.
Their fluctuations are modelled by a $\Ntrait$-dimensional log-Brownian process $\Brownian\nodeexp$ at each node $\Setnode$ of the tree, including the root and leaves.
The first dimension (indexed by $0$) of the log-Brownian contain $\Ne$, and the second dimension (indexed by $1$) contains $\mu$.
The log-Brownian process and variables of interest~($\mu$ and $\Ne$) are linked by an exponential transformation:
\begin{equation}
    \begin{dcases}
        \Ne\nodeexp = \e^{ \brownian_{0}\nodeexp } \\
        \mu\nodeexp = \e^{ \brownian_{1}\nodeexp },
    \end{dcases}
\end{equation}
where the effective population size at the root is set to $1$ for identifiability of the fitness profiles.
It is important to note that inferred correlation between $\Ne$, $\mu$ and other \acrshort{LHT} is thus in the log space, and that quantitative \acrshort{LHT} must be inputted in log scale.

Along a branch $\Setbranch$ of the tree, a log-Brownian process starts at the oldest node at the tip of the branch~($\nodeUp$), and ends at the youngest node~($\nodeDown$).
However we are interested in the average over the branch to define the codon substitution matrices along the branch.
In the case of log-Brownian process, the most likely path (or geodesic) from $\Brownian^{(\nodeUp)}$ to $\Brownian^{(\nodeDown)}$ is the straight line, and therefore, it would make sense to take the mean value of $\e^{\Brownian\nodeexp}$ along this geodesic.
We then have $\Ne\branchexp$ and $\mu\branchexp$ for each branch $\Setbranch$ of the tree:
\begin{equation}
    \label{eq:branchNemu}
    \begin{dcases}
        \Ne\branchexp = \dfrac{\e^{\brownian_{0}^{(\nodeDown)}} - \e^{\brownian_{0}^{(\nodeUp)}}}{\brownian_{0}^{(\nodeDown)} - \brownian_{0}^{(\nodeUp)}} \\
        \mu\branchexp = \dfrac{\e^{\brownian_{1}^{(\nodeDown)}} - \e^{\brownian_{1}^{(\nodeUp)}}}{\brownian_{1}^{(\nodeDown)} - \brownian_{1}^{(\nodeUp)}}.
    \end{dcases}
\end{equation}

Moreover, the rate of change of the log-Brownian process per unit of time is constant and determined by the positive semi-definite and symmetric covariance matrix $\CovarianceMatrix$, and thus the distribution of $\Brownian^{(\nodeDown)}$ is multivariate Gaussian, with mean $\Brownian^{(\nodeUp)}$ and variance $\branchtime\branchexp \CovarianceMatrix$:
\begin{equation}
    \label{eq:DistribBrownian}
    \Brownian^{(\nodeDown)} \sim \mathcal{N}\left(\Brownian^{(\nodeUp)}, \branchtime\branchexp \CovarianceMatrix \right),\ \Setbranch
\end{equation}

\begin{figure}[htbp]
    \centering
    \begin{tikzpicture}[->,>=stealth',shorten >=1pt,auto,node distance=0.6cm and 1.2cm,semithick]
        \tikzstyle{every state}=[]

        \node[state] (P) {$\Probmatrix\branchsiteexp$};
        \node[state] (Q) [below right=of P] {$\Submatrix\branchsiteexp$};
        \node[state] (R) [below right=of Q] {$\Mutmatrix$};
        \node[state] (BL) [above right=of P] {$\branchlength\branchexp$};
        \node[state] (Ne) [above right=of Q] {$\Ne\branchexp$};
        \node[state] (Bb) [above right=of Ne] {$\Brownian\nodeexp $};
        \node[state] (Mu) [left=of Bb] {$\mu\branchexp$};
        \node[state] (f) [right=of Q] {$\Fit\siteexp $};
        \node[state] (Ex) [BLUE, below right=of R] {$\Exchan$};
        \node[state] (Equi) [BLUE, right=of R] {$\Mutequi$};
        \node[state] (dT) [above left=of Bb] {$\branchtime\branchexp $};
        \node[state] (T) [BLUE, right=of dT] {$\age\nodeexp$};
        \node[state] (Base) [BLUE, above right=of f] {$\Profile\catexp$};
        \node[state] (cat) [BLUE, right=of f] {$\catsite$};
        \node[state] (ExH) [RED, right=of Ex] {$\dfrac{1}{6}, 6$};
        \node[state] (EquiH) [RED, right=of Equi] {$\dfrac{1}{4}, 4$};
        \node[state] (Unif) [RED, right=of T] {$\uniform$};
        \node[state] (C) [BLUE, right=of Bb] {$\contrast\branchexp$};
        \node[state] (Cov) [BLUE, right=of C] {$\Covariancematrix$};
        \node[state] (baseH) [RED, right=of Base] {$\concentrationProfile, \centerProfile $};
        \node[state] (sb) [BLUE, right=of cat] {$\StickBreaking$};
        \node[state] (CovH) [RED, right=of Cov] {$\covariancekappa, \covariancedf$};
        \node[state] (sbH) [RED, right=of sb] {$\stickbreakinghyper$};

        \path
        (Q) edge [black] node [above right] {\ref{eq:Probmatrix}} (P)
        (dT) edge [black] node [above left] {\ref{eq:branchlength}} (BL)
        (Mu) edge [black] node [] {} (BL)
        (BL) edge [black] node [] {} (P)
        (Ne) edge [black] node {} (Q)
        (R) edge [black] node {} (Q)
        (Bb) edge [black] node {} (Ne)
        (Bb) edge [black] node [below] {\ref{eq:branchNemu}} (Mu)
        (f) edge [black] node [above] {\ref{eq:subrates}} (Q)
        (Ex) edge [black] node [] {} (R)
        (Equi) edge [black] node [below] {\ref{eq:gtr-mutrates}} (R)
        (T) edge [black] node [above] {\ref{eq:ageTobranchtime}} (dT)
        (dT) edge [black] node {} (Bb)
        (Base) edge [black] node {} (f)
        (cat) edge [black] node [above] {\ref{eq:sitefitness}} (f)
        (ExH) edge [dashed, BLUE] node [above] {\ref{eq:DistribExchan}} (Ex)
        (EquiH) edge [dashed, BLUE] node [above] {\ref{eq:DistribMutequi}} (Equi)
        (Unif) edge [dashed, BLUE] node [above] {\ref{eq:Distribage}} (T)
        (C) edge [black] node [above] {\ref{eq:independent_contrast}} (Bb)
        (Cov) edge [dashed, BLUE] node [above] {\ref{eq:Distribcontrast}} (C)
        (baseH) edge [dashed, BLUE] node [above] {\ref{eq:DistribBase}} (Base)
        (sb) edge [dashed, BLUE] node [above] {\ref{eq:DistribMultinomial}} (cat)
        (CovH) edge [dashed, BLUE] node [above] {\ref{eq:Distribcovariance}} (Cov)
        (sbH) edge [dashed, BLUE] node [above] {\ref{eq:DistribStickBreaking},\ref{eq:Beta}} (sb);
    \end{tikzpicture}

    \caption[Directed acyclic graph of dependencies between variables]{
    Directed acyclic graph (DAG) of dependencies between variables.
    Nodes of the directed acyclic graph are the variables, and edges are the functions.
    Hyper-parameters are depicted in {\color{RED}{red}} circles, random variables in {\color{BLUE}{blue}} circles, and transformed variables in black.
    {\color{BLUE}{Blue}} dashed line denotes a drawing from a random distribution, and black solid lines denote a function.
    For a given node, all the nodes pointing toward him (upstream) are its dependencies which determines its distribution.
    The other way around, following the arrows in the DAG (downstream), simple prior distributions are combined together to form more complex joint prior distribution which ultimately defines the prior distribution of the model.
    }\label{fig:DAG-MutSelNe}
\end{figure}

We make a change of variable as to define the branch-wise independent contrast $\contrast\branchexp$:
\begin{align}
    \contrast\branchexp &= \dfrac{\brownian^{(\nodeDown)} - \brownian^{(\nodeUp)}}{\sqrt{\branchtime\branchexp}} \\
    \label{eq:independent_contrast}
    \iff \brownian^{(\nodeDown)} &= \brownian^{(\nodeUp)} + \sqrt{\branchtime\branchexp}\contrast\branchexp
\end{align}
And these contrasts are i.i.d.
from a multivariate normal distribution:
\begin{equation}
    \label{eq:Distribcontrast}
    \contrast\branchexp \sim \mathcal{N}\left(\vecZero, \Covariancematrix \right), \Setbranch
\end{equation}
The prior on the covariance matrix is an invert Wishart distribution, parameterized by $\covariancekappa=1$ and with $\covariancedf=\Ntrait + 1$ degrees of freedom:
\begin{equation}
    \label{eq:Distribcovariance}
    \CovarianceMatrix \sim \text{Wishart}^{-1} (\covariancekappa \Identitymatrix, \covariancedf)
\end{equation}

\subsection{Codon substitution rates}

The mutation rate between codons $\ci$ and $\cj$, denoted $\mu_{\itoj}$ depends on the underlying nucleotide change between the codons.
First, if codons $\ci$ and $\cj$ are not neighbours, $\mu_{\itoj}$ is equal to $0$.
Second, if codons $\ci$ and $\cj$ are only one mutation away, $\mu_{\itoj}$ is given by the nucleotide relative rate~(${\mutmatrix_{\nucitoj}}$) scaled by the mutation rate per time~($\mu$).
Technically, the $4$-dimensional nucleotide relative rate matrix~($\Mutmatrix$) is normalized such that we expect $1$ substitution per unit of time, hence the scaling by $\mu$.

For a given branch $\branch$ and a given site $\site$, the codon substitution rate (per unit of time) matrix $\Submatrix\branchsiteexp$ is given by:
\begin{equation}
    \label{eq:subrates}
    \begin{dcases}
        \submatrix\branchsiteexp_{\itoj} = 0\text{ if codons $\ci$ and $\cj$ are not neighbors,} \\
        \submatrix\branchsiteexp_{\itoj} = \mutmatrix_{\nucitoj}\text{ if codons $\ci$ and $\cj$ are synonymous,} \\
        \submatrix\branchsiteexp_{\itoj} = \mutmatrix_{\nucitoj} \dfrac{4\Ne\branchexp \left({\fitj\siteexp - \fiti\siteexp}\right)}{{1 - \e^{4\Ne\branchexp\left({\fiti\siteexp - \fitj\siteexp}\right)} }} \text{ if non-syn.,}\\
        \submatrix\branchsiteexp_{\ci, \ci} = - \sum\limits_{ \cj \neq \ci, \jSetCodon} \submatrix\branchsiteexp_{\itoj},
    \end{dcases}
\end{equation}
We see from this equation that, $\fit$ and $\Ne$ are confounded, such that increasing the effective population size while decreasing the fitnesses by the same factor leads to the same substitution rate.

The branch lengths $\branchlength\branchexp$ are defined as the expected number of neutral substitutions per \acrshort{DNA} site along a branch:
\begin{equation}
    \label{eq:branchlength}
    \branchlength\branchexp = \mu\branchexp \branchtime\branchexp
\end{equation}
Together, the probability of transition between codons for a given branch $\branch$ and site $\site$ is:
\begin{equation}
    \label{eq:Probmatrix}
    \Probmatrix\branchsiteexp = \e^{\branchlength\branchexp \Submatrix\branchsiteexp},
\end{equation}
which are the matrices necessary to compute the likelihood of the data ($\data$) given the parameters of the model using the pruning algorithm.

\subsection{Bayesian implementation}
\label{sec:Bayesian}
Markov chain Monte Carlo (\acrshort{MCMC}) are run for 4000 points and the first 1000 points are discarded as burn-in, the convergence is then assessed (see section~\ref{subsec:chain-convergence} in supplementary materials), as both site-specific fitness and branch $\Ne$ have the same posterior mean.
Most phylogenetic \acrshort{MCMC} samplers target the distribution over the model parameters, which means that they have to repeatedly invoke the pruning algorithm to recalculate the pruning-based likelihood which is most often the limiting step of the \acrshort{MCMC}.
An alternative, which is used here, is to do the \acrshort{MCMC} conditionally on the detailed substitution history $\subhistory$, thus doing the \acrshort{MCMC} over the augmented configuration~($\subhistory$, $\data$), under the target distribution obtained by combining the mapping-based likelihood with the prior over model parameters.

The key idea that makes this strategy efficient is that the mapping-based likelihood depends on compact summary statistics of $\subhistory$, leading to very fast evaluation of the likelihood.
On the other hand, this requires to implement more complex \acrshort{MCMC} procedures that have to alternate between:
\begin{enumerate}
    \item sampling $\subhistory$ conditionally on the data and the current parameter configuration.
    \item re-sampling the parameters conditionally on $\subhistory$.
\end{enumerate}

To implement the mapping-based \acrshort{MCMC} sampling strategy, we first sample the detailed substitution history $\subhistory$ for all sites along the tree.
Several methods exist for doing this~\citep{Nielsen2002,Rodrigue2008}.
Then, we write down the probability of $\subhistory$ given the parameters, and finally, we collect all factors that depend on some parameter of interest and make some simplifications.
This ultimately leads to relatively compact sufficient statistics (see section~\ref{sec:sufficient-statistics-mutselne} in supplementary materials) that are fast to evaluate~\citep{Irvahn2014,Davydov2016}.

As an example, making an \acrshort{MCMC} move on the $\Ne$ at a given node of the tree is drastically faster since only the mapping-based likelihood (using path sufficient statistics) at the neighbouring branches of the node is necessary, and not computing the likelihood for the all trees.

\subsection{Correlation between traits}
\label{sec:Correlation}
The correlation between trait $\traiti$ and trait $\traitj \in \traitInterval$ can be obtained from the covariance matrix $\Covariancematrix$:
\begin{equation}
    \rho_{\traiti, \traitj} = \dfrac{\Covariancematrix_{\traiti, \traitj}}{\sqrt{\Covariancematrix_{\traiti, \traiti} \Covariancematrix_{\traitj, \traitj}}}
\end{equation}

\subsection{Simulations}
\label{sec:Simulation}
To test the robustness of the model, $4$ parameterized simulators were developed: \texttt{SimuDiv}, \texttt{SimuPoly}, \texttt{SimuFold} \& \texttt{SimuGeo}.
All $4$ simulators use a log-Brownian multivariate process to model conjointly the changes in the mutation rate per generation, the generation time and $\Ne$, in logarithm space.
\texttt{SimuDiv}, \texttt{SimuFold} \& \texttt{SimuGeo} all simulate point substitutions along the phylogenetic tree.
The simulator starts from an initial sequence at equilibrium.
The change in fitness is computed for all possible mutant, hence computing all strictly positive substitution rates.
At each point, the next substitution is chosen proportional to the rate as in Gillespie's algorithm~\citep{Gillespie1977}.
At each node, the process is split, and finally the process is stopped at the leaves of the tree.
\texttt{SimuPoly} simulates explicitly each generation along the phylogeny under a Wright-Fisher population, consisting of three steps: mutation, selection and genetic drift of alleles.
Mutations are drawn randomly based on the probability of mutation.
Drift is modelled as a multinomial distribution on the allele counts.
We assumed that the \acrshort{DNA} sequence is composed of exons, with no linkage between exons, and total linkage of sites within an exon.
Moreover, in \texttt{SimuPoly} $\Ne$ can also be modelled as a sum of a log-Brownian process and an Ornstein-Uhlenbeck process.
The log-Brownian motion takes into account long-term fluctuations, while the Ornstein-Uhlenbeck can take into account short fluctuations of $\Ne$.
In \texttt{SimuDiv} and \texttt{SimuPoly} each codon site contribute independently to the fitness depending on the encoded amino acids, through site-specific amino-acid fitness profiles experimentally determined~\citep{Bloom2017}.
However, in \texttt{SimuFold} the fitness of a sequence is computed as the probability of the protein to be in the folded state.
\texttt{SimuFold} is in practice a \texttt{C++} adaptation of a Java code previously published~\citep{Goldstein2016, Goldstein2017}, where we allow for changes in $\Ne$ and $\mu$ along a phylogenetic tree.
Section~\ref{sec:supp-mat-simulations} in supplementary materials describes the models in more details, as well as performance of the inference model against them.
The simulators written in \texttt{C++} are publicly available under MIT license at \url{https://github.com/ThibaultLatrille/SimuEvol}
